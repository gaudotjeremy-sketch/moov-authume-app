<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scanner â€“ Moov Authume</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ« Validation des bons â€“ Moov Authume</h1>

    <label>Ã‰vÃ©nement :</label>
    <select id="event">
      {% for e in events %}
        <option value="{{ e }}">{{ e }}</option>
      {% endfor %}
    </select>

    <label>BÃ©nÃ©vole :</label>
    <select id="volunteer">
      {% for v in volunteers %}
        <option value="{{ v }}">{{ v }}</option>
      {% endfor %}
    </select>

    <div id="reader" style="width:300px; margin:auto;"></div>
    <p id="result" class="result"></p>

    <script>
      function onScanSuccess(decodedText) {
        const [name, email, expiration] = decodedText.split("|");
        const event = document.getElementById("event").value;
        const volunteer = document.getElementById("volunteer").value;

        fetch("/validate_qr", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({event, member: name, volunteer})
        })
        .then(r => r.json())
        .then(data => {
          const res = document.getElementById("result");
          if (data.status === "ok") {
            res.innerHTML = "âœ… " + data.message;
            res.style.color = "green";
          } else {
            res.innerHTML = "âŒ " + data.message;
            res.style.color = "red";
          }
        });
      }

      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras.length) {
          html5QrCode.start(cameras[0].id, {fps: 10, qrbox: 250}, onScanSuccess);
        }
      });
    </script>

    <p><a href="/" class="btn">â¬… Retour Ã  lâ€™accueil</a></p>
  </div>
</body>
</html>

